# if ~/profile exists, source it
if [ -e "${HOME}/profile" ]; then
    source "${HOME}/profile"
fi

# pipenv
export PIPENV_VENV_IN_PROJECT=true
if command -v pipenv > /dev/null 2>&1; then
    eval "$(pipenv --completion)"
fi

# poetry
export POETRY_VIRTUALENVS_IN_PROJECT=true

# set EDITOR
if command -v nvim > /dev/null 2>&1; then
    export EDITOR=nvim
elif command -v vim > /dev/null 2>&1; then
    export EDITOR=vim
fi
if [ "${TERM_PROGRAM:-}" = "vscode" ]; then
    export EDITOR="code --wait"
fi

# pyenv
if [ -d "${HOME}/.pyenv" ]; then
    export PYENV_ROOT="${HOME}/.pyenv"
    export PATH="$PYENV_ROOT/bin:$PATH"
    if command -v pyenv 1>/dev/null 2>&1; then
        eval "$(pyenv init - "${SHELL##*/}")"
    fi
fi

# brew
if command -v brew > /dev/null 2>&1; then
    PATH=$(brew --prefix coreutils)/libexec/gnubin:$PATH
    PATH=$(brew --prefix openssl)/bin:$PATH
    export PATH
fi

# SSH_AUTH_SOCK（sh_profile と同じ内容とすること）
#  Bitwarden が起動している場合は Bitwarden の SSH エージェントを使う
if [ -S "/Users/$(whoami)/Library/Containers/com.bitwarden.desktop/Data/.bitwarden-ssh-agent.sock" ]; then
    SSH_AUTH_SOCK="/Users/$(whoami)/Library/Containers/com.bitwarden.desktop/Data/.bitwarden-ssh-agent.sock"
    export SSH_AUTH_SOCK
fi
if [ -S "/Users/$(whoami)/.bitwarden-ssh-agent.sock" ]; then
    SSH_AUTH_SOCK="/Users/$(whoami)/.bitwarden-ssh-agent.sock"
    export SSH_AUTH_SOCK
fi
#  SSH で接続していない場合は ssh-agent を起動する
if [ -z "${SSH_CONNECTION}" ] && [ -z "${SSH_AUTH_SOCK:-}" ]; then
    if command -v ssh-agent > /dev/null 2>&1; then
        eval "$(ssh-agent)" > /dev/null 2>&1
    fi
fi

# mise
if command -v mise > /dev/null 2>&1; then
    eval "$(mise activate "${SHELL##*/}")"
fi

if command -v whence > /dev/null 2>&1; then
    # awsume
    if whence -w awsume | grep -v "alias" > /dev/null 2>&1; then
        alias awsume='. awsume'
    fi

    # VSCode
    if command -v VSCode > /dev/null 2>&1; then
        :
    else
        if [ -e "/Applications/Visual Studio Code.app/Contents/MacOS/Electron" ]; then
            if whence -w VSCode | grep -v "alias" > /dev/null 2>&1; then
                alias VSCode='"/Applications/Visual Studio Code.app/Contents/MacOS/Electron"'
            fi
        fi
    fi
fi

# Enable BuiltKit
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1

if [ -z "${DOCKER_HOST:-}" ]; then
    if command -v docker > /dev/null 2>&1; then
        # Docker がインストールされている
        DOCKER_CMD_PATH=$(command -v docker)
        if [ "${DOCKER_CMD_PATH#"$HOME"}" != "${DOCKER_CMD_PATH}" ]; then
            # rootless docker がインストールされているようだ
            if [ -z "${XDG_RUNTIME_DIR:-}" ]; then
                # XDG_RUNTIME_DIR が設定されていないようだ
                if [ -d "/run/user/${UID}" ]; then
                    export XDG_RUNTIME_DIR="/run/user/${UID}"
                else
                    export XDG_RUNTIME_DIR="${HOME}/.docker/run"
                fi
            fi
            export DOCKER_HOST=unix://${XDG_RUNTIME_DIR}/docker.sock
        fi
    fi
fi

# kubectl
if command -v kubectl > /dev/null 2>&1; then
    eval "$(kubectl completion "${SHELL##*/}")"
fi

# typer
if command -v typer > /dev/null 2>&1; then
    eval "$(typer --show-completion)"
fi

# task
if command -v task > /dev/null 2>&1; then
    eval "$(task --completion "${SHELL##*/}")"
fi

# uv
if command -v uv > /dev/null 2>&1; then
    eval "$(uv generate-shell-completion "${SHELL##*/}")"
fi
