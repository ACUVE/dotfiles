#!/usr/bin/env bash

set -euo pipefail

# docker-credential-helper specification implementation using Bitwarden CLI
# Supports: get, store, erase, list
# Uses a single Bitwarden item's memo field to store all Docker credentials as JSON

ITEM_NAME="docker-credentials"

# Function to check if bw is installed and unlocked
check_bw() {
    if ! command -v bw &> /dev/null; then
        echo '{"error":"Bitwarden CLI (bw) is not installed"}' >&2
        exit 1
    fi

    # Check if session is unlocked
    if ! bw status | grep -q '"status":"unlocked"'; then
        echo '{"error":"Bitwarden is locked. Please unlock with: export BW_SESSION=$(bw unlock --raw)"}' >&2
        exit 1
    fi
}

# Get the docker-credentials item
get_credentials_item() {
    local all_items
    all_items=$(bw list items 2>/dev/null)

    if [[ -z "$all_items" ]] || [[ "$all_items" == "[]" ]]; then
        echo ""
        return
    fi

    echo "$all_items" | jq -r --arg name "$ITEM_NAME" \
        '.[] | select(.name == $name and .type == 2) | @json' | head -n 1
}

# Get all credentials from the memo field
get_all_credentials() {
    local item
    item=$(get_credentials_item)

    if [[ -z "$item" ]]; then
        echo '{}'
        return
    fi

    local notes
    notes=$(echo "$item" | jq -r '.notes // "{}"')

    # Validate JSON
    if ! echo "$notes" | jq empty 2>/dev/null; then
        echo '{}'
        return
    fi

    echo "$notes"
}

# Save all credentials to the memo field
save_all_credentials() {
    local credentials="$1"
    local item
    item=$(get_credentials_item)

    if [[ -n "$item" ]]; then
        # Update existing item
        local item_id
        item_id=$(echo "$item" | jq -r '.id')

        local updated_item
        updated_item=$(echo "$item" | jq --arg notes "$credentials" '.notes = $notes')

        echo "$updated_item" | bw encode | bw edit item "$item_id" > /dev/null
    else
        # Create new secure note item
        local new_item
        new_item=$(jq -n \
            --arg name "$ITEM_NAME" \
            --arg notes "$credentials" \
            '{
                type: 2,
                name: $name,
                notes: $notes,
                secureNote: {
                    type: 0
                }
            }')

        echo "$new_item" | bw encode | bw create item > /dev/null
    fi

    bw sync > /dev/null 2>&1 || true
}

# Command: get <server_url>
# Input: server URL from stdin
# Output: {"ServerURL":"...","Username":"...","Secret":"..."}
cmd_get() {
    local server_url
    server_url=$(cat)

    check_bw

    # Get all credentials
    local all_creds
    all_creds=$(get_all_credentials)

    # Extract credential for the requested server URL
    local cred
    cred=$(echo "$all_creds" | jq -r --arg url "$server_url" '.[$url] // empty')

    if [[ -z "$cred" ]] || [[ "$cred" == "null" ]]; then
        echo '{"error":"credentials not found"}' >&2
        exit 1
    fi

    # Parse username and secret
    local username secret
    username=$(echo "$cred" | jq -r '.Username // empty')
    secret=$(echo "$cred" | jq -r '.Secret // empty')

    if [[ -z "$username" ]] || [[ -z "$secret" ]]; then
        echo '{"error":"invalid credentials format"}' >&2
        exit 1
    fi

    # Output in docker-credential-helper format
    jq -n \
        --arg url "$server_url" \
        --arg user "$username" \
        --arg pass "$secret" \
        '{ServerURL: $url, Username: $user, Secret: $pass}'
}

# Command: store
# Input: {"ServerURL":"...","Username":"...","Secret":"..."}
# Output: none (success) or error
cmd_store() {
    local input
    input=$(cat)

    local server_url username secret
    server_url=$(echo "$input" | jq -r '.ServerURL // empty')
    username=$(echo "$input" | jq -r '.Username // empty')
    secret=$(echo "$input" | jq -r '.Secret // empty')

    # Validate input format
    if [[ -z "$server_url" ]] || [[ -z "$username" ]] || [[ -z "$secret" ]]; then
        echo '{"error":"invalid input: ServerURL, Username, and Secret are required"}' >&2
        exit 1
    fi

    check_bw

    # Get current credentials
    local all_creds
    all_creds=$(get_all_credentials)

    # Add or update the credential for this server URL
    local updated_creds
    updated_creds=$(echo "$all_creds" | jq \
        --arg url "$server_url" \
        --arg user "$username" \
        --arg pass "$secret" \
        '.[$url] = {Username: $user, Secret: $pass}')

    # Save back to Bitwarden
    save_all_credentials "$updated_creds"
}

# Command: erase <server_url>
# Input: server URL from stdin
# Output: none (success) or error
cmd_erase() {
    local server_url
    server_url=$(cat)

    check_bw

    # Get current credentials
    local all_creds
    all_creds=$(get_all_credentials)

    # Check if the credential exists
    local exists
    exists=$(echo "$all_creds" | jq -r --arg url "$server_url" 'has($url)')

    if [[ "$exists" != "true" ]]; then
        # No credential to delete, succeed silently
        exit 0
    fi

    # Remove the credential for this server URL
    local updated_creds
    updated_creds=$(echo "$all_creds" | jq --arg url "$server_url" 'del(.[$url])')

    # Save back to Bitwarden
    save_all_credentials "$updated_creds"
}

# Command: list
# Output: {"<server_url>":"<username>",...}
cmd_list() {
    check_bw

    # Get all credentials
    local all_creds
    all_creds=$(get_all_credentials)

    # Convert to the list format: {"url": "username", ...}
    local result
    result=$(echo "$all_creds" | jq 'with_entries(.value = .value.Username)')

    echo "$result"
}

# Main dispatcher
main() {
    if [[ $# -eq 0 ]]; then
        echo "Usage: $0 <get|store|erase|list>" >&2
        echo "This is a docker-credential-helper for Bitwarden" >&2
        exit 1
    fi

    local command=$1

    case "$command" in
        get)
            cmd_get
            ;;
        store)
            cmd_store
            ;;
        erase)
            cmd_erase
            ;;
        list)
            cmd_list
            ;;
        *)
            echo "Unknown command: $command" >&2
            echo "Supported commands: get, store, erase, list" >&2
            exit 1
            ;;
    esac
}

main "$@"
